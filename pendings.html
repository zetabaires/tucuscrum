<!DOCTYPE html>
<html>
<head>
    <title>Votes</title>
    <link rel="stylesheet" type="text/css" href="assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/bootstrap/css/bootstrap.min.css" />

    <link rel="stylesheet" type="text/css" href="assets/css/endless.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/endless-skin.css" />

    <link rel="stylesheet" type="text/css" href="assets/css/notifications.css" />

    <script src="assets/js/console.extenssions.js"></script>

    <script src="assets/js/angular.min.js"></script>
    <script src="assets/js/tools.js"></script>
    <script src="assets/js/constants.js"></script>

    <script src="assets/js/entities.js"></script>
    <script src="assets/js/functions.js"></script>

    <script>

        let app = angular.module('app', ['ui-notification'])
            .config(function (NotificationProvider) {
                NotificationProvider.setOptions({
                    delay: 10000,
                    startTop: 20,
                    startRight: 10,
                    verticalSpacing: 20,
                    horizontalSpacing: 20,
                    positionX: 'right',
                    positionY: 'bottom'
                });
            });

        app.controller('appcontroller', function ($scope, $http, Notification) {
            let $program = new Program($http, Notification);

            $scope.nombreUsuarios;
            $scope.nombreLista;
            $scope.nombreTarjetas;
            $scope.nombreLabels;

            $scope.users = [];
            $scope.optionsList = [];
            $scope.checkLists = [];
            $scope.cardsPending = [];

            let boardLists = [];
            let boardCards = [];
            let boardChecklists = [];

            $program.getBoard(boardId).then(data => {
                boardLists = data;

                $scope.optionsList = data.map(m => ({ name: m.name }));
            })

            $http.get(getUrl(`board/${boardId}/cards?fields=name,idList,labels`)).then(data =>
                boardCards = data.data)

            $http.get(getUrl(`boards/${boardId}/checklists`)).then(data => {

                boardChecklists = Enumerable.from(data.data)
                    .where(m => m.state != 'complete' && m.checkItems.any(x => x.name.contains('@')))
                    .selectMany(m => {
                        return m.checkItems.map(p => ({
                            idList: boardCards.filter(x => x.id == m.idCard).map(x => x.idList).first(),
                            idCard: m.idCard,
                            name: p.name,
                            users: p.name.split(' ').filter(p => p.contains('@'))
                        }));
                    })
                    .selectMany(m => m.users.map(p => ({ idList: m.idList, idCard: m.idCard, name: m.name, user: trimEnd(p, '.') })))
                    .groupBy(m => m.user)
                    .select(m => ({
                        user: m.key(),
                        pendings: Enumerable.from(m.getSource())
                            .groupBy(p => p.idCard)
                            .select(p => ({ idCard: p.key(), pendings: p.getSource() }))
                            .toArray()
                    }))
                    .toArray();

                setTimeout(() => {
                    $('[data-toggle=collapse]').collapse();
                    $('[data-toggle=tooltip]').tooltip();
                    $('.collapse-box').on('click', function (e) {
                        e.preventDefault();

                        $(this).closest('.pending-box').find('.collapse').collapse('toggle');
                    })
                }, 100)


                //boardLists.forEach(m => {
                //    let checklist = boardChecklists.filter(p => p.idList == m.id);

                //    if (!checklist.any()) return;

                //    let cads = boardCards.filter(x => checklist.any(p => p.idCard == x.id));

                //    cads.forEach(x => {
                //        let cardCheckList = checklist.filter(p => p.idCard == x.id);

                //        x.pendings = cardCheckList;
                //    });

                //    m.cardsPending = cads;
                //});

                //console.log(boardLists);
            })

            $scope.getCard = (id) => {
                return boardCards.find(m => m.id == id);
            };

            $scope.groupBycard = (pendings) => {
                return Enumerable.from(pendings)
                    .groupBy(m => m.idCard)
                    .select(m => ({ idCard: m.key(), pendings: m.getSource() }))
                    .toArray();
            };

            $scope.getList = (id) => {
                return boardLists.find(m => m.id == id);
            };

            $scope.selectOptionList = (opt) => {
                $scope.nombreLista = opt;
            };

            $scope.checkOwner = function (user, pending) {
                return pending && user && pending.user == user;
            }

            $scope.buscar = function () {

                let listas = boardChecklists || [];

                if ($scope.nombreUsuarios)
                    listas = listas.filter(m => {
                        return $scope.nombreUsuarios.split(',').any(p => m.user.contains(p.trim()));
                    });

                if ($scope.nombreLista)
                    listas = listas.filter(l => l.pendings.any(m => {
                        let list = $scope.getList($scope.getCard(m.idCard).idList);

                        return list && $scope.nombreLista.split(',').any(p => list.name.contains(p.trim()));
                    }));

                if ($scope.nombreTarjetas)
                    listas = listas.filter(l => l.pendings.any(m => {
                        let card = $scope.getCard(m.idCard);

                        return card && $scope.nombreTarjetas.split(',').any(p => card.name.contains(p.trim()));
                    }));

                if ($scope.nombreLabels)
                    listas = listas.filter(l => l.pendings.any(m => {
                        let card = $scope.getCard(m.idCard);

                        if ($scope.nombreLabels.contains('&'))
                            return card && $scope.nombreLabels.split('&').every(p => card.labels.any(l => l.name.contains(p.trim())));
                        else
                            return card && $scope.nombreLabels.split(',').any(p => card.labels.any(l => l.name.contains(p.trim())));
                    }));

                //let find = boardLists.find(m =>
                //    m.name.contains($scope.nombreLista) ||
                //    (m.cardsPending &&
                //        (m.cardsPending.any(p => $scope.nombreTarjetas.split(',').any(x => p.name.contains(x)))) ||
                //        (m.cardsPending.any(p => $scope.nombreLabels.split(',').any(x => p.labels.contains(x))))
                //    )
                //);

                return listas;
            }

            $scope.optionsVisible = (list, name) => {
                if (list.map(m => m.name).includes(name)) return list;

                return list.filter(m =>
                    m.name.contains(name) || (m.labels && m.labels.any(p => p.name.contains(name))));
            };

            $scope.getTotalPendingsCount = function (pendings) {
                return Enumerable.from(pendings).selectMany(m => m.pendings.count()).sum();
            }

            $scope.colors = {
                "blue": "info",
                "green": "success",
                "yellow": "warning",
                "orange": "warning",
                "red": "danger",
                "lime": "danger",
                "black": "secondary",
                "purple": "primary"
            };

            $scope.getFiltered = function (filter, list) {
                if (!filter)
                    return list;

                var result = list;

                let parts = filter.split(',');

                let exclusive = parts.filter(m => m.contains('&'));
                let inclusive = parts.filter(m => !exclusive.includes(m));

                if (exclusive.any())
                    result = result.filter(m =>
                        exclusive.first().split('&').every(x =>
                            $scope.getCard(m.idCard).labels.any(p => p.name.contains(x.trim()))));

                result = result.filter(m =>
                    !inclusive.any() || inclusive.any(x =>
                        $scope.getCard(m.idCard).name.contains(x.trim()) ||
                        $scope.getList($scope.getCard(m.idCard).idList).name.contains(x.trim()) ||
                        m.pendings.any(p => p.name.contains(x.trim()))));


                return result;
            }
        });

        function collapse(btn) {
            $(btn).trigger('blur');

            btn.hiding = !btn.hiding;

            $(btn).closest('.card-body').find('.pendings.collapse').collapse(btn.hiding ? 'hide' : 'show');
        }

    </script>
    <style>
        /*.auto-complete.dropdown-menu {
            min-height: inherit !important;
            max-height: 200px !important;
        }*/

        body {
            font-size: 14px;
        }

        .bs-callout-info {
            border-left-color: #1b809e;
        }

        .bs-callout {
            padding: 10px 15px;
            border: 1px solid #eee;
            border-left-width: 5px;
            border-radius: 3px;
        }

        .mouse-pointer {
            cursor: pointer;
        }

        .input-group .btn {
            border: solid 1px #ced4da;
        }

        .input-group input {
            border-right: none;
        }

        .input-group-append .btn:first-child {
            color: #ced4da;
            border-left: none;
        }
    </style>
</head>
<body ng-app="app" ng-controller="appcontroller">

    <div class="main-container grayed">
        <div class="container-fluid">
            <div class="p-3">

                <h1>Pendientes</h1>

                <!--Buscador-->
                <div class="row">

                    <div class="col-3">
                        <label>Nombres</label>
                        <div class="input-group">
                            <input class="form-control" placeholder="Separados por coma (,)" ng-model="nombreUsuarios" />
                            <span class="input-group-append">
                                <button title="clean filter" data-toggle="tooltip" class="btn btn-sm bg-white" ng-click="nombreUsuarios = ''"><i class="fa fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="col-3">
                        <label>Listas</label>
                        <div class="input-group">
                            <input class="form-control" placeholder="Separados por coma (,)" ng-model="nombreLista" />
                            <span class="input-group-append">
                                <button title="clean filter" data-toggle="tooltip" class="btn btn-sm bg-white" ng-click="nombreLista = ''"><i class="fa fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="col-3">
                        <label>Tarjetas</label>
                        <div class="input-group">
                            <input class="form-control" placeholder="Separados por coma (,)" ng-model="nombreTarjetas" />
                            <span class="input-group-append">
                                <button title="clean filter" data-toggle="tooltip" class="btn btn-sm bg-white" ng-click="nombreTarjetas = ''"><i class="fa fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="col-3">
                        <label>Labels</label>
                        <div class="input-group">
                            <input class="form-control" placeholder="Ej. refi, core <=> refi & core" ng-model="nombreLabels" />
                            <span class="input-group-append">
                                <button title="clean filter" data-toggle="tooltip" class="btn btn-sm bg-white" ng-click="nombreLabels = ''"><i class="fa fa-times"></i></button>
                            </span>
                        </div>
                    </div>

                </div>

                <hr />

                <!--Usuarios-->
                <div class="row">

                    <div class="col-6" ng-repeat="itemUser in buscar()">

                        <div class="card card-default">
                            <!--Datos usuario-->
                            <div class="card-header px-3 py-2 mouse-pointer" data-toggle="collapse" data-target="#{{itemUser.user.replace('@', '')}}">
                                <button class="btn btn-sm btn-default p-0 float-right">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <h5 class="m-0">
                                    {{itemUser.user}}
                                    <span class="float-right mr-2" style="font-size: 14px">
                                        <span class="badge" style="font-size: 14px">
                                            ({{getTotalPendingsCount(itemUser.pendings)}})
                                            pendientes
                                        </span>
                                        de
                                        <span class="badge" style="font-size: 14px">
                                            {{itemUser.pendings.count()}}
                                            tarjetas
                                        </span>
                                    </span>
                                </h5>
                            </div>
                            <!--Datos tarjetas-->
                            <div class="collapse" id="{{itemUser.user.replace('@', '')}}">
                                <div class="card-body py-3 px-2">
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <input class="form-control" ng-model="itemUser.filter" placeholder="Separados por comas (,) y & con labels: Ej. validar, data & refi" />
                                            <span class="input-group-append">
                                                <button title="clean filter" data-toggle="tooltip" class="btn btn-sm" ng-click="itemUser.filter = ''"><i class="fa fa-times"></i></button>
                                                <button title="toggle all" data-toggle="tooltip" class="btn btn-sm" onclick="collapse(this)"><i class="fa fa-compress-alt"></i></button>
                                            </span>
                                        </div>
                                    </div>

                                    <a class="d-block bs-callout bs-callout-info mb-2 mouse-pointer pending-box" href="https://trello.com/c/{{getCard(item.idCard).id}}" target="_blank" ng-repeat="item in getFiltered(itemUser.filter, itemUser.pendings)">
                                        <button class="btn collapse-box float-right py-0 px-1">
                                            <i class="fa fa-compress-alt"></i>
                                        </button>
                                        <div>
                                            <span class="mr-1 badge badge-{{colors[label.color] || 'default'}}" ng-repeat="label in getCard(item.idCard).labels">{{label.name}}</span>
                                        </div>
                                        {{getCard(item.idCard).name}}
                                        -
                                        <span class="badge barge-warning">
                                            ({{ getList(getCard(item.idCard).idList).name }})
                                        </span>
                                        <div class="collapse show pendings">
                                            <ul class="pl-3 mt-2">
                                                <li class="mb-2 {{checkOwner(itemUser.user, pending) ? 'alert-info px-2 py-1' : ''}}" ng-repeat="pending in item.pendings">
                                                    -
                                                    {{pending.name}}
                                                </li>
                                            </ul>
                                        </div>
                                    </a>

                                </div>
                            </div>
                        </div>

                        <hr />
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/jquery-3.4.1.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery.sparkline.min.js"></script>
    <script src="assets/js/angular-ui-notification.js"></script>

    <script src="assets/js/linq.min.js"></script>
</body>
</html>